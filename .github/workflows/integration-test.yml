name: "Integration Test"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  integration-test:
    runs-on: ubuntu-latest
    environment: CI
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 10.11.0
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build Action
        run: pnpm build
        
      # Setup test environment (Tiny Server)
      - name: Start tiny server
        run: |
          printf "<html><head><title>Demo</title></head><body>hi</body></html>" > index.html
          python3 -m http.server 3000 &> /dev/null &
          npx -y wait-on http://127.0.0.1:3000

      # Create normrc.json configuration
      - name: Create normrc.json Config
        run: |
          cat > normrc.json <<EOF
          {
            "settings": {
              "baseUrl": "http://127.0.0.1:3000",
              "numberOfRuns": 2
            },
            "budgets": {
              "global": {
                "timings": {
                  "largest-contentful-paint": 5000
                }
              }
            },
            "routes": ["/"]
          }
          EOF

      - name: Run WAPMetrics Action (Local Build)
        uses: ./packages/collector-action
        with:
          config: "normrc.json"
          token: ${{ secrets.WAPMETRICS_TOKEN }}
          api-url: ${{ vars.WAPMETRICS_API_URL }} 
          out: ".wapmetrics/wapmetrics-run.tgz"

      - name: Verify Artifact Exists
        run: |
          if [ -f ".wapmetrics/wapmetrics-run.tgz" ]; then
            echo "Artifact created successfully!"
            ls -l .wapmetrics/wapmetrics-run.tgz
          else
            echo "Error: Artifact was not created."
            exit 1
          fi

      - name: Upload Artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: wapmetrics-run
          path: .wapmetrics/wapmetrics-run.tgz

